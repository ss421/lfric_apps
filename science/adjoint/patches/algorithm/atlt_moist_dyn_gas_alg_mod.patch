@@ -9,12 +9,12 @@
     use mesh_mod, only : mesh_type
     use function_space_collection_mod, only : function_space_collection
     use tl_moist_dyn_gas_kernel_mod, only : tl_moist_dyn_gas_kernel_type
-    use adj_moist_dyn_gas_kernel_mod, only : adj_moist_dyn_gas_kernel_type
+    use atl_moist_dyn_gas_kernel_mod, only : atl_moist_dyn_gas_kernel_type
     use finite_element_config_mod, only : element_order_h, element_order_v
     use fs_continuity_mod, only : wtheta
     use constants_mod, only : i_def, r_def
     use setop_random_kernel_mod, only : setop_random_kernel_type
-    use log_mod, only : log_event, log_level_error, log_level_info, log_scratch_space
+    use log_mod, only : log_event, log_level_error, log_level_info, log_scratch_space, log_level_debug
     real(kind=r_def), parameter :: overall_tolerance = 1500.0_r_def
     type(mesh_type), pointer, intent(in) :: mesh
     type(field_type), dimension(3), intent(in), optional :: chi
@@ -26,12 +26,15 @@
     type(field_type) :: mr_v_input
     real(kind=r_def) :: moist_dyn_gas_inner_prod
     real(kind=r_def) :: mr_v_inner_prod
+    real(kind=r_def) :: moist_dyn_gas_sf
+    real(kind=r_def) :: mr_v_sf
     real(kind=r_def) :: inner1
     real(kind=r_def) :: moist_dyn_gas_moist_dyn_gas_input_inner_prod
     real(kind=r_def) :: mr_v_mr_v_input_inner_prod
     real(kind=r_def) :: inner2
     real(kind=r_def) :: MachineTol
     real(kind=r_def) :: relative_diff
+    real(kind=r_def), parameter :: eps = 1.0e-30_r_def
 
     vector_space_wtheta_ptr => function_space_collection%get_fs(mesh,element_order_h,element_order_v,wtheta)
     call moist_dyn_gas%initialise(vector_space=vector_space_wtheta_ptr, name='moist_dyn_gas')
@@ -44,12 +47,22 @@
     call invoke(setval_random(moist_dyn_gas), setval_x(moist_dyn_gas_input, moist_dyn_gas), setval_random(mr_v), &
 &setval_x(mr_v_input, mr_v), tl_moist_dyn_gas_kernel_type(moist_dyn_gas, mr_v), x_innerproduct_x(moist_dyn_gas_inner_prod, &
 &moist_dyn_gas), x_innerproduct_x(mr_v_inner_prod, mr_v))
+    write( log_scratch_space, * ) "atlt_moist_dyn_gas inner products:"
+    call log_event( log_scratch_space, log_level_debug )
+    write( log_scratch_space, * ) "moist_dyn_gas inner product = ", moist_dyn_gas_inner_prod
+    call log_event( log_scratch_space, log_level_debug )
+    write( log_scratch_space, * ) "mr_v inner product = ", mr_v_inner_prod
+    call log_event( log_scratch_space, log_level_debug )
+    moist_dyn_gas_sf = 1.0_r_def / (moist_dyn_gas_inner_prod + eps)
+    mr_v_sf = 1.0_r_def / (mr_v_inner_prod + eps)
     inner1 = 0.0_r_def
-    inner1 = inner1 + moist_dyn_gas_inner_prod
-    inner1 = inner1 + mr_v_inner_prod
+    inner1 = inner1 + moist_dyn_gas_inner_prod * moist_dyn_gas_sf
+    inner1 = inner1 + mr_v_inner_prod * mr_v_sf
+    call invoke( inc_a_times_X( moist_dyn_gas_sf, moist_dyn_gas ), &
+                 inc_a_times_X( mr_v_sf, mr_v ) )
     moist_dyn_gas_moist_dyn_gas_input_inner_prod = 0.0_r_def
     mr_v_mr_v_input_inner_prod = 0.0_r_def
-    call invoke(adj_moist_dyn_gas_kernel_type(moist_dyn_gas, mr_v), x_innerproduct_y(moist_dyn_gas_moist_dyn_gas_input_inner_prod, &
+    call invoke(atl_moist_dyn_gas_kernel_type(moist_dyn_gas, mr_v), x_innerproduct_y(moist_dyn_gas_moist_dyn_gas_input_inner_prod, &
 &moist_dyn_gas, moist_dyn_gas_input), x_innerproduct_y(mr_v_mr_v_input_inner_prod, mr_v, mr_v_input))
     inner2 = 0.0_r_def
     inner2 = inner2 + moist_dyn_gas_moist_dyn_gas_input_inner_prod
